{% extends 'base.html'%}
{% load static %}

{% block page-css %}
<style media="print">
    .hidden-print {
    display: none;
}
</style>
<Style>

page {
    background: white;
    display: block;
    margin: 0 auto;
    margin-bottom: 0.5cm;
    box-shadow: 0 0 0.5cm rgba(0,0,0,0.5);
    }
    page[size="A4"] {  
    width: 21cm;
    height: 29.7cm; 
}
@media print {
    body, page {
        margin: 0;
        box-shadow: 0;
    }
    body.modal-open {
        visibility: hidden;
    }
    body.modal-open .modal .modal-header,
    body.modal-open .modal .modal-body {
        visibility: visible; /* make visible modal body and header */
    }
    .modal {
        position: absolute;
        left: 0;
        top: 0;
        margin: 0;
        padding: 0;
        overflow: visible!important;
    }
}
body{
    word-wrap:break-word;
}
p{
    color:black;
}
#letter_complaint{
    text-align: justify
}
.modal {

   top: 10px;
   bottom: 10px;
   left: 0;
}
</Style>
{% endblock%}

{% block title %}
    Student Lodge Complaint
{% endblock %}


{% block content%}
<div id="content" class="content">
    {% if messages %}
    <p class="alert alert-danger">
        {% for message in messages %}
            <i><strong>{{ message }}</strong></i>
        {% endfor %}
    </p>
    {% endif %} 

    <h1 class="page-header mb-1">File a complaint</h1>
	<p class="mb-5">Page Description</p>
    <!-- end page-header -->
    <!-- begin panel -->
    <div class="row" hidden><img src="https://www.freelogovectors.net/wp-content/uploads/2017/05/pup-logo-Polytechnic_University_of_the_Philippines.png" style="width: 130px; height: 130px;"/></div>

    <div class="panel" id="refresh">
        <div class="panel-heading p-25">
            <div class="btn-group btn-group-toggle pull-right" data-toggle="buttons">
                <button class="btn btn-success"  data-toggle="modal" href="#modal-add" id="btn_rem"><i class="fas fa-plus"></i> File Complaint</button>
            </div>
            <h2 class="panel-title" style="font-size:16px;">Letter of complaint</h2>
        </div>
        <div class="panel-body">
            {% if stud_complaints %}
            <table id="data-table" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th width="1%"></th>
                        <th data-orderable="false">Complaint Detail</th>
                        <th data-orderable="false">Complaint Status</th>
                        <th data-orderable="false">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for osas_t_complaint in stud_complaints %}
                    <tr class="odd gradeA" id="{{ osas_t_complaint.comp_id }}">
                        <td width="1%" class="f-s-600 text-inverse">{{ forloop.counter }}</td>
                        <td width="35%"><dl class="row mb-0 p-2" style="line-height: .6rem;">
                            <dd class="col-sm-8 gritter-  off_name" ><strong>{{ osas_t_complaint.comp_stud_id.stud_no }}</strong></dd>
                            {% if osas_t_complaint.comp_letter %}
                            <dd class="col-sm-8 gritter- text-nowrap " ><a class="excuse{{osas_t_complaint.comp_id}}" data-toggle="modal" href="#modal-edit" onClick="editComplaint('{{ osas_t_complaint.comp_id }}')" ><span class="label label-success status_" >Complaint letter <i class="far fa-envelope text-white-lighter fa-lg"></i></span></a></dd>
                            {% endif %}
                            {% if osas_t_complaint.comp_pic %}
                            <dd class="col-sm-8 gritter- text-nowrap m-t-2" ><a data-toggle="modal" href="#modal-edit_pic" onClick="editComplaintPic('{{ osas_t_complaint.comp_id }}')" ><span class="label label-success status_">Proof image <i class="far fa-image text-white-lighter fa-lg"></i></span></a></dd>
                            {% endif %}
                        </dl>
                        </td>
                        <td class="align-middle" width="35%" ><dl class="row mb-0 p-2" style="line-height: .6rem;">
                            <dd class="col-sm-8 gritter-  off_name" ><strong>{{ osas_t_complaint.comp_number }}</strong></dd>
                            <dd class="col-sm-8 gritter-  off_name" >{{ osas_t_complaint.comp_datecreated|date:"Y-m-d" }}</dd>
                            {% if osas_t_complaint.comp_status == "COMPLETED"%}
                            <dd class="col-sm-8 gritter-"><strong><span class="badge badge-danger status_ ss{{osas_t_complaint.comp_status}}">{{ osas_t_complaint.comp_status }}</span></strong></dd>
                            {% elif osas_t_complaint.comp_status == "ACTIVE"%}
                            <dd class="col-sm-8 gritter- "><strong><span class="badge badge-warning status_ ss{{osas_t_complaint.comp_status}}">{{ osas_t_complaint.comp_status }}</span></strong></dd>
                            {% elif osas_t_complaint.comp_status == "CANCELLED"%}
                            <dd class="col-sm-8 gritter- "><strong><span class="badge badge-success status_ ss{{osas_t_complaint.comp_status}}">{{ osas_t_complaint.comp_status }}</span></strong></dd>
                            {% else %}
                            <dd class="col-sm-8 gritter-"><strong><span class="badge badge-info status_ ss{{osas_t_complaint.comp_status}}">{{ osas_t_complaint.comp_status }}</span></strong></dd>
                            {% endif %}
                        </dl>
                        </td>
                        <td  class="align-middle" width="29%"> 
                            <div class="text-nowrap">
                                <div class="btn-group ">
                                    {% if osas_t_complaint.comp_letter %}
                                    <button id="print_btn" class="btn btn-gray" onClick="printComplaint('{{osas_t_complaint.comp_id}}')"><i class="fas fa-print mr-2"></i>Print</button>
                                    {% endif %}
                                    <button id="delete-btn" class="btn btn-danger" onClick="deleteComplaint('{{osas_t_complaint.comp_id}}')"><i class="fas fa-trash-alt mr-2"></i>Delete</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    
                </tbody>
            </table>
            {% else %}
            <table id="data-table" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th width="1%"></th>
                        <th data-orderable="false">Complaint Detail</th>
                        <th data-orderable="false">Complaint Status</th>
                        <th data-orderable="false">Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table> 
            {% endif %}
        </div>
    </div>
</div>
<div class="modal fade" id="modal-edit_pic" role="dialog"  data-backdrop="static">
    <div class="modal-dialog modal-md" role="document" id="myModal">
        <div class="modal-content">
            <div class="panel panel-inverse" >
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true" style="color: gray; margin: 6px;">×</button>  
                <form  method="POST" class="form-control-with-bg" id="form5" action="{% url 'student_file_complaint_edit_proof' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="panel-body">
                        <div class="col">
                            <h1 class="page-header mb-1">Edit attached file</h1>
                            <p class="mb-5">Page Description</p>
                            <div class="col-lg-12 form-check-inline" id="error">
                            </div>
                            <div class="col-12" id="image_link">
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <a class="btn btn-white pull-right m-l-10" data-dismiss="modal">Back<i class="fas fa-reply m-l-3 zoom"></i></a>
                    </div>
                    <br>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modal-edit" role="dialog" >
    <div class="modal-dialog modal-lg" role="document" id="myModal">
        <page size='A4' style="word-wrap:break-word;" id="lettere">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true" style="color: gray; margin: 6px;" data-target="#modal-edit" >×</button>
            
        </page>
    </div>
</div>

{% endblock %}

{% block page-level %}
	<script src="{%static 'OsasSystem/assets/plugins/bootstrap-sweetalert/sweetalert.min.js' %}"></script>
    <script src="{%static 'OsasSystem/assets/js/demo/ui-modal-notification.demo.min.js' %}"></script>
    <script src="{%static 'OsasSystem/assets/plugins/parsley/dist/parsley.js' %}"></script>
    <script src="{%static 'OsasSystem/assets/index.js' %}"></script>
{% endblock %}

{% block page-js %}
<script>
    $(document).ready(function() {
        
    });
</script>
<script>
function printComplaint(comp_id){
    console.log(comp_id)
    if (comp_id) {
        $.ajax({
            url: '{% url "student_file_complaint_get" %}',
            type: "POST",
            data: {
                comp_id: comp_id,
                csrfmiddlewaretoken: "{{ csrf_token }}",
            },
            dataType: 'json',
            success: function(data){
                if (data.comp_val) {
                    console.log(data.comp_val.letter)
                    var wme = window.open("","", "width = 793.7007874px, height = 1122.519685px");
                    wme.document.write('<page size="A4" style="word-wrap:break-word;"><div style="padding: 20px;" id="letter_complaint"><div class="row" style="margin-left: 40px; margin-top: 20px;" id="puplogo"><img src="/media/PUPLOGO.png" style="width: 111px; height: 108px;"/><div style="float: right; margin-left: 40px;"><p style="font-family: Arial, Helvetica, sans-serif; font-size: 18px; color: black; margin-top: 15px;">Republic of the Philippines</p><p style="font-family: Trajan Pro; font-size: 20px; color: black; margin-top: -15px;"><b>Polytechnic University of the Philippines</b></p><p style="font-family: Arial, Helvetica, sans-serif; color: black; margin-top: -15px;"><b>Quezon City Branch</b></p></div><br/></div><div id="textt" style="margin: 50px 50px 50px 50px;"><label style="margin-bottom: -10px;">'+data.comp_val.lname+', '+data.comp_val.fname+' '+data.comp_val.mname+'</label><br><label style="margin-bottom: -10px;">'+data.comp_val.course+'</label><br><label style="margin-bottom: -10px;">'+data.comp_val.date+'</label><br><br><label style="margin-bottom: -10px;">Prof. Demelyn Espejo Monzon</label><br><label style="margin-bottom: -10px;">Head OSAS</label><br><label style="margin-bottom: -10px;">Office of the Student Affairs and Services</label><br><br><br><label style="margin-bottom: -10px;">Dear Prof. Demelyn Espejo Monzon,</label><br><br>'+data.comp_val.letter+'<br><br><label style="margin-bottom: -10px;">Yours Sincerely,</label><br><br><label style="margin-bottom: -10px;">'+data.comp_val.lname+', '+data.comp_val.fname+' '+data.comp_val.mname+'</label></div></div></page> ')
                    wme.document.close();
                    wme.focus();
                    wme.print();
                    wme.close();
                }
            },
            error: function(error){
                console.log(error)
            }
        })
    }
}

function editComplaint(comp_id) {
    if (comp_id) {
        tr_id = comp_id;
        $('#comp_id').val(comp_id);
        console.log(comp_id)
        if (document.getElementById("letter_complaint")){
            var myobj = document.getElementById("letter_complaint");
            myobj.remove();
        }
        $.ajax({
            url: '{% url "student_file_complaint_get" %}',
            type: "POST",
            data: {
                comp_id: comp_id,
                csrfmiddlewaretoken: "{{ csrf_token }}",
            },
            dataType: 'json',
            success: function(data){
                if (data.comp_val) {
                    console.log(data.comp_val.letter)
                    $("#lettere").append('<div style="padding: 20px;" id="letter_complaint"><div class="row" style="margin-left: 40px; margin-top: 20px;" id="puplogo"><img src="/media/PUPLOGO.png" style="width: 111px; height: 108px;"/><div style="float: right; margin-left: 40px;"><p style="font-family: Arial, Helvetica, sans-serif; font-size: 18px; color: black; margin-top: 15px;">Republic of the Philippines</p><p style="font-family: Trajan Pro; font-size: 20px; color: black; margin-top: -15px;"><b>Polytechnic University of the Philippines</b></p><p style="font-family: Arial, Helvetica, sans-serif; color: black; margin-top: -15px;"><b>Quezon City Branch</b></p></div><br/></div><div id="textt" style="margin: 50px 50px 50px 50px;"><label style="margin-bottom: -10px;">'+data.comp_val.lname+', '+data.comp_val.fname+' '+data.comp_val.mname+'</label><br><label style="margin-bottom: -10px;">'+data.comp_val.course+'</label><br><label style="margin-bottom: -10px;">'+data.comp_val.date+'</label><br><br><label style="margin-bottom: -10px;">Prof. Demelyn Espejo Monzon</label><br><label style="margin-bottom: -10px;">Head OSAS</label><br><label style="margin-bottom: -10px;">Office of the Student Affairs and Services</label><br><br><br><label style="margin-bottom: -10px;">Dear Prof. Demelyn Espejo Monzon,</label><br><br>'+data.comp_val.letter+'<br><br><label style="margin-bottom: -10px;">Yours Sincerely,</label><br><br><label style="margin-bottom: -10px;">'+data.comp_val.lname+', '+data.comp_val.fname+' '+data.comp_val.mname+'</label></div></div> ')
                }
            },
            error: function(error){
                console.log(error)
            }
        })
    }
}

function editComplaintPic(comp_id) {
    if (comp_id) {
        tr_id = comp_id;
        $('#comp_id').val(comp_id);
        console.log(comp_id)
        if (document.getElementById("image_label")){
            var myobj = document.getElementById("image_label");
            myobj.remove();
        }
        if (document.getElementById("proof_link")){
            var myobj = document.getElementById("proof_link");
            myobj.remove();
        }
        $.ajax({
            url: '{% url "student_file_complaint_get" %}',
            type: "POST",
            data: {
                comp_id: comp_id,
                csrfmiddlewaretoken: "{{ csrf_token }}",
            },
            dataType: 'json',
            success: function(data){
                if (data.comp_val) {
                    console.log(data.comp_val.pic)
                    proof_image = data.comp_val.pic.replace(/\"/g, "")
                    $("#image_link").append('<label style="font-size: 12px;" id="image_label" class="col-form-label text-md-right">Current proof image: </label><br><a id="proof_link" href="/media/'+proof_image+'" target="blank" name="curr_pic">'+proof_image+'</a>')
                    
                }
            },
            error: function(error){
                console.log(error)
            }
        })
    }
}

// $(".modal").on("hidden.bs.modal", function(){

//     $("#modal-edit").html("");
// });

</script>
{% endblock %}